<input id='ipfile' type='file'><br>
<!-- Output Filename <input id='outputfile' type='text' name='outputfile'><br>
Extension <input id='extension' type='text' name='extension'> -->

<button onclick="confirmPostProduct()">button</button>

<script>

    //getLastProductId

    function getLastFileDataId() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (this.readyState == 4) {
                const lastFileDataID = JSON.parse(this.responseText);
                console.log("coco1");
                console.log(lastFileDataID);
                postProduct(lastFileDataID);

                //var catalogTable = "";
            };
        }
        xhr.open("GET", "http://localhost:8082/getLastFileDataId", true);
        xhr.send();

    }



    function confirmPostProduct() {
        console.log("first part");
        var file = document.getElementById('ipfile').files[0];
        handleFileSelect(file);
    }

    function handleFileSelect(file) {
        if (!file) {
            return null;
        } else {
            var maxMbSize = 2; // 2MB appears to be the max for XHttpRequest send function
            console.log("File size: " + file.size / 1_000_000);
            if (file.size / 1_000_000 > maxMbSize) {
                console.log("file to big");
                return null;
            } else {
                console.log('handle the file');
                //var file = document.getElementById('files').files[0]; // FileList object
                var reader = new FileReader();
                // Read in the image file as a data URL.
                if (file) {
                    reader.readAsBinaryString(file);
                }
                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        console.log("middle part");
                        var fileData = {};

                        const fileName = file.name;
                        const lastDot = fileName.lastIndexOf('.');

                        const name = fileName.substring(0, lastDot);
                        const ext = fileName.substring(lastDot + 1);

                        const binaryData = e.target.result;
                        //Converting Binary Data to base 64
                        const base64String = window.btoa(binaryData);

                        fileData.name = name;
                        fileData.extension = ext;
                        fileData.data = base64String;

                        // console.log("file!");
                        // console.log(fileData);
                        postFileData(fileData);
                    }
                })(file);


            }
        }
    }


    function postFileData(fileData) {


        console.log("last part")
        console.log(fileData.data);

        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function () {
            console.log('ready');
            if (this.readyState == 4) {
                getLastFileDataId();
            }
        };

        var objJSON = JSON.stringify(fileData);
        xhr.open("POST", "http://localhost:8082/postFileData", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(objJSON);
    }

    function postProduct(fileId) {
        console.log('start postProduct');
        // if (document.getElementById("ipaddoredit").innerHTML == "Update product") {
        //     // var xhr = new XMLHttpRequest();
        //     // var theObject = {};
        //     // theObject.name = document.getElementById("ipname").value;
        //     // theObject.price = document.getElementById("ipprice").value;
        //     // theObject.eanCode = document.getElementById("ipeanCode").value;
        //     // theObject.description = document.getElementById("ipdescription").value;
        //     // theObject.length = document.getElementById("iplength").value;
        //     // theObject.width = document.getElementById("ipwidth").value;
        //     // theObject.height = document.getElementById("ipheight").value;
        //     // theObject.weight = document.getElementById("ipweight").value;
        //     // document.getElementById("ipedit").innerHTML = "Edit";
        //     // theObject.id = document.getElementById("idhidden").value;
        //     // document.getElementById("ipaddoredit").innerHTML = "Add product to catalog";

        //     // xhr.onreadystatechange = function () {
        //     //     showProducts();
        //     // };

        //     // var objJSON = JSON.stringify(theObject);
        //     // xhr.open("POST", "http://localhost:8082/editproduct", true);
        //     // xhr.setRequestHeader("Content-Type", "application/json");
        //     // xhr.send(objJSON);
        // } else {
        var namep = "name1";
        var pricep = 123;
        var eanCodep = null;
        var descriptionp = null;
        var lengthp = null;
        var widthp = null;
        var heightp = null;
        var weightp = null;
        // var namep = document.getElementById("ipname").value;
        // var pricep = document.getElementById("ipprice").value;
        // var eanCodep = document.getElementById("ipeanCode").value;
        // var descriptionp = document.getElementById("ipdescription").value;
        // var lengthp = document.getElementById("iplength").value;
        // var widthp = document.getElementById("ipwidth").value;
        // var heightp = document.getElementById("ipheight").value;
        // var weightp = document.getElementById("ipweight").value;

        var theObject = {};
        theObject.name = namep;
        theObject.price = pricep;
        theObject.eanCode = eanCodep;
        theObject.description = descriptionp;
        theObject.length = lengthp;
        theObject.width = widthp;
        theObject.height = heightp;
        theObject.weight = weightp;
        theObject.fileData = { "id": fileId };

        var objJSON = JSON.stringify(theObject);
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            // showProducts(); //Andere function ook gebruiken voor hierboven.
        };
        console.log("post new product");
        console.log(theObject);
        xhr.open("POST", "http://localhost:8082/newproduct", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(objJSON);
        // }

        // document.getElementById("ipname").value = "";
        // document.getElementById("ipprice").value = "";
        // document.getElementById("ipeanCode").value = "";
        // document.getElementById("ipdescription").value = "";
        // document.getElementById("iplength").value = "";
        // document.getElementById("ipwidth").value = "";
        // document.getElementById("ipheight").value = "";
        // document.getElementById("ipweight").value = "";
    }

</script>